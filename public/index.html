<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DCF AI Valuation</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background:#0f172a;
      color:#e5e7eb;
      font-family:Arial, sans-serif;
      padding:20px;
    }
    h1 { color:#38bdf8; }
    input, button {
      padding:10px;
      border-radius:6px;
      border:none;
      margin-top:5px;
    }
    button { background:#38bdf8; cursor:pointer; }
    .card {
      background:#020617;
      padding:15px;
      border-radius:10px;
      margin-top:20px;
    }
    .low { color:#22c55e; }
    .mid { color:#eab308; }
    .high { color:#ef4444; }
    li { cursor:pointer; }
  </style>
</head>

<body>

<h1>üìä DCF AI Valuation</h1>

<div class="card">
  <input id="tickerInput" placeholder="Enter ticker (AAPL)" />
  <br>
  <button onclick="analyze()">Analyze</button>
  <button onclick="addToWatchlist()">‚≠ê Add to Watchlist</button>
</div>

<div class="card" id="results" style="display:none;">
  <h2 id="title"></h2>
  <p>Market Price: $<span id="price"></span></p>
  <p>Intrinsic Value (DCF): $<span id="dcf"></span></p>
  <p>AI Valuation Risk: <span id="risk"></span></p>
  <p>Verdict: <span id="verdict"></span></p>
  <canvas id="chart" height="120"></canvas>
</div>

<div class="card">
  <h2>‚≠ê Watchlist</h2>
  <ul id="watchlist"></ul>
</div>

<script>
const cache = {};
let chart;

function getWatchlist() {
  return JSON.parse(localStorage.getItem("watchlist") || "[]");
}
function saveWatchlist(list) {
  localStorage.setItem("watchlist", JSON.stringify(list));
}
function renderWatchlist() {
  const ul = document.getElementById("watchlist");
  ul.innerHTML = "";
  getWatchlist().forEach(item => {
    const li = document.createElement("li");
    li.innerHTML = `${item.ticker} ‚Äî <b class="${item.riskClass}">${item.riskScore ?? "?"}</b>`;
    li.onclick = () => {
      document.getElementById("tickerInput").value = item.ticker;
      analyze();
    };
    ul.appendChild(li);
  });
}

function addToWatchlist() {
  const ticker = document.getElementById("tickerInput").value.toUpperCase();
  if (!ticker) return;
  const list = getWatchlist();
  if (!list.find(x => x.ticker === ticker)) {
    list.push({ ticker });
    saveWatchlist(list);
    renderWatchlist();
  }
}

async function analyze() {
  const ticker = document.getElementById("tickerInput").value.toUpperCase();
  if (!ticker) return;

  if (cache[ticker]) {
    render(cache[ticker]);
    return;
  }

  const res = await fetch(
    `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=6mo&interval=1d`
  );
  const json = await res.json();
  const r = json.chart.result?.[0];
  if (!r) return alert("Ticker not found");

  const prices = r.indicators.quote[0].close.filter(Boolean);
  const labels = r.timestamp.map(t => new Date(t * 1000).toLocaleDateString());
  const price = prices.at(-1);

  const dcf = improvedDCF(price);
  const risk = aiRisk(prices, price, dcf);

  const payload = { ticker, price, dcf, risk, prices, labels };
  cache[ticker] = payload;
  updateWatchlistScore(ticker, risk);
  render(payload);
}

function improvedDCF(price) {
  const discount = 0.1;
  const growth = 0.06;
  const terminal = 0.02;

  let fcf = price * 0.18; // normalized FCF proxy
  let value = 0;

  for (let i = 1; i <= 10; i++) {
    fcf *= (1 + growth);
    value += fcf / Math.pow(1 + discount, i);
  }

  const terminalValue = (fcf * (1 + terminal)) / (discount - terminal);
  value += terminalValue / Math.pow(1 + discount, 10);

  return Math.max(value, 0);
}

function aiRisk(prices, price, dcf) {
  const returns = prices.slice(1).map((p, i) => (p - prices[i]) / prices[i]);
  const volatility = std(returns) * 100;
  const valuationGap = Math.abs(dcf - price) / price * 100;
  const trendPenalty = price < avg(prices.slice(-50)) ? 20 : 5;

  const score = Math.min(100, Math.round(volatility + valuationGap + trendPenalty));
  return score;
}

function updateWatchlistScore(ticker, score) {
  const list = getWatchlist();
  list.forEach(item => {
    if (item.ticker === ticker) {
      item.riskScore = score;
      item.riskClass = score < 30 ? "low" : score < 60 ? "mid" : "high";
    }
  });
  saveWatchlist(list);
  renderWatchlist();
}

function avg(a) { return a.reduce((x,y)=>x+y,0)/a.length; }
function std(a) {
  const m = avg(a);
  return Math.sqrt(avg(a.map(x => (x-m)**2)));
}

function render({ ticker, price, dcf, risk, prices, labels }) {
  document.getElementById("results").style.display = "block";
  document.getElementById("title").innerText = ticker;
  document.getElementById("price").innerText = price.toFixed(2);
  document.getElementById("dcf").innerText = dcf.toFixed(2);

  const r = document.getElementById("risk");
  r.innerText = risk;
  r.className = risk < 30 ? "low" : risk < 60 ? "mid" : "high";

  document.getElementById("verdict").innerText =
    dcf > price ? "Undervalued ‚úÖ" : "Overvalued ‚ö†Ô∏è";

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type:"line",
    data:{ labels, datasets:[{ data:prices, borderColor:"#38bdf8", pointRadius:0 }] },
    options:{ plugins:{ legend:{ display:false } } }
  });
}

renderWatchlist();
</script>

</body>
</html>
